#!/usr/bin/env bash

# Description:
# ------------
# Initial config and installation of newly installed Arch.
#
# lastmod: 2019-07-26T10:20:13+02:00
# Change History:
# ---------------
# - 2019-07-26: added random hostname part
# - 2019-07-25: added grc + placeholder for random hostname script
# - 2019-07-23:
#   - added diffrent package groups
#   - added mirrorlist ranking
# - 2019-07-22: created

# String definitions for colored printf output
# [ ERROR ] in light red
# [ INFO  ] in light green
# [ INPUT ] in light yellow
STR_ERROR="[ \e[91mERROR\e[0m ]"
STR_INFO="[ \e[92mINFO\e[0m  ]"
STR_INPUT="[ \e[93mINPUT\e[0m ]"

##########################################
# Check if root / sudo
##########################################
if [ "$EUID" -eq 0 ]; then
  printf "%b Do not run with sudo / as root.\n" "${STR_ERROR}" >&2
  exit 1
fi

##########################################
# Preperation
##########################################
# enable and stat DHCP client
sudo systemctl enable dhcpcd
sudo systemctl start dhcpcd

# enable colored output for pacman
sudo sed -i 's/^#Color/Color/' /etc/pacman.conf
sudo sed -i 's/^#TotalDownload/TotalDownload/' /etc/pacman.conf

sudo pacman -Syyu

# install 'pacman-contrib' package for 'rankmirrors'
# optain mirrorlist and rank 20 fastest
sudo pacman -S --needed --noconfirm pacman-contrib
curl https://www.archlinux.org/mirrorlist/all/https/ -o /tmp/mirrorlist
sed -i 's/^#Server/Server/' /tmp/mirrorlist
printf "%b Ranking top 20 pacman mirrors by speed...\n" "${STR_INFO}"
rankmirrors -n 20 /tmp/mirrorlist /tmp/mirrorlist.ranked
sudo cp -f /tmp/mirrorlist.ranked /etc/pacman.d/mirrorlist
rm -f /tmp/mirrorlist /tmp/mirrorlist-ranked
printf "%b Mirrors ranked and saved to /etc/pacman.d/mirrorlist.\n" "${STR_INFO}"

# install 'git'
sudo pacman -S --needed --noconfirm git
# install yay from AUR
git clone https://aur.archlinux.org/yay.git /tmp/yay
cd /tmp/yay
makepkg -si
rm -rf /tmp/yay


##########################################
# System Packages
##########################################
pacman_system_pkgs=(
                    grc
                    htop
                    )
for package in ${pacman_system_pkgs[*]}; do
  sudo pacman -S --needed --noconfirm ${package}
done

# add grc aliases to bashrc skeleton
# Ã©cho "[[ -s '/etc/profile.d/grc.bashrc' ]] && source /etc/profile.d/grc.bashrc" >> ?



##########################################
# Networking
##########################################
pacman_network_pkgs=(
                    cifs-utils
                    net-snmp
                    nfs-utils
                    openssh
                    openvpn
                    smbclient
                    wget
                    whois
                    )

for package in ${pacman_network_pkgs[*]}; do
  sudo pacman -S --needed --noconfirm ${package}
done

sudo systemctl enable rpcbind
sudo systemctl start rpcbind

# set random hostname on each boot
sudo cp ./setrandomhostname/setrandomhostname.service /etc/systemd/system/setrandomhostname.service
sudo chmod 644 /etc/systemd/system/setrandomhostname.service
sudo cp ./setrandomhostname/setrandomhostname.sh /usr/local/bin/setrandomhostname.sh
sudo chmod 755 /usr/local/bin/setrandomhostname.sh
sudo systemctl enable setrandomhostname

##########################################
# Development
##########################################
pacman_dev_pkgs=(
                python
                python-pip
                python2
                python2-pip
                )

for package in ${pacman_dev_pkgs[*]}; do
  sudo pacman -S --needed --noconfirm ${package}
done


##########################################
# Desktop environment
##########################################
pacman_desktop_pkgs=(
                    lightdm
                    lightdm-gtk-greeter
                    papirus-icon-theme
                    xfce4
                    xfce4-goodies
                    xorg
                    xorg-fonts
                    )

sudo localectl set-x11-keymap de-latin1
sudo systemctl enable lightdm.service


##########################################
# Install fonts
##########################################
sudo pacman -S --needed --noconfirm ttf-croscore
sudo pacman -S --needed --noconfirm ttf-bitstream-vera
sudo pacman -S --needed --noconfirm ttf-dejavu
sudo pacman -S --needed --noconfirm ttf-droid
sudo pacman -S --needed --noconfirm ttf-roboto
sudo pacman -S --needed --noconfirm noto-fonts
sudo pacman -S --needed --noconfirm ttf-liberation
yay -S --noconfirm ttf-ms-win10
yay -S --noconfirm ttf-courier-prime




##########################################
# Mandatory tools
##########################################
pacman -S -needed --noconfirm firefox
