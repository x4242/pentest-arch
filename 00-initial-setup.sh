#!/usr/bin/env bash

# Description:
# ------------
# Initial config and installation of newly installed Arch.
#
# lastmod: 2019-07-28T18:10:19+02:00
# Change History:
# ---------------
# - 2019-07-28: created

# String definitions for colored printf output
# [ ERROR ] in light red
# [ INFO  ] in light green
# [ INPUT ] in light yellow
STR_ERROR="[ \e[91mERROR\e[0m ]"
STR_INFO="[ \e[92mINFO\e[0m  ]"
STR_INPUT="[ \e[93mINPUT\e[0m ]"

##########################################
# Check if root / sudo
##########################################
if [ ! "$EUID" -eq 0 ]; then
  printf "%b Run as root.\n" "${STR_ERROR}" >&2
  exit 1
fi


##########################################
# Preperation
##########################################
# enable and stat DHCP client
printf "%b Enabling and starting dhcpcd ...\n" "${STR_INFO}"
systemctl enable dhcpcd
systemctl start dhcpcd

# configure pacman
printf "%b Configuring pacman ...\n" "${STR_INFO}"
sed -i 's/^#Color/Color/' /etc/pacman.conf
sed -i 's/^#TotalDownload/TotalDownload/' /etc/pacman.conf

# update
pacman -Syyu

# install 'pacman-contrib' package for 'rankmirrors', optain mirrorlist
# and rank 20 fastest
pacman -S --needed --noconfirm pacman-contrib
curl https://www.archlinux.org/mirrorlist/all/https/ -o /tmp/mirrorlist
sed -i 's/^#Server/Server/' /tmp/mirrorlist
printf "%b Ranking top 20 pacman mirrors by speed ...\n" "${STR_INFO}"
rankmirrors -n 20 /tmp/mirrorlist > /tmp/mirrorlist.ranked
cp -f /tmp/mirrorlist.ranked /etc/pacman.d/mirrorlist
rm -f /tmp/mirrorlist /tmp/mirrorlist-ranked
printf "%b Mirrors ranked and saved to /etc/pacman.d/mirrorlist.\n" "${STR_INFO}"


##########################################
# System Packages
##########################################
pacman_system_pkgs=(
                    grc
                    htop
                    tmux
                    vim2
                    )
for package in ${pacman_system_pkgs[*]}; do
  pacman -S --needed --noconfirm ${package}
done

##########################################
# Prepare /etc/skel
##########################################
printf "%b Preparing /etc/skel ...\n" "${STR_INFO}"
mkdir /etc/skel/Downloads
cp -f ./skel/bashrc /etc/skel/.bashrc
cp -f ./skel/bash_aliases /etc/skel/.bash_aliases
cp -f ./skel/bash_logout /etc/skel/.bash_logout


##########################################
# Networking
##########################################
pacman_network_pkgs=(
                    cifs-utils
                    dnsutils
                    macchanger
                    net-snmp
                    netcat
                    nfs-utils
                    nmap
                    openssh
                    openvpn
                    smbclient
                    tcpdump
                    wget
                    whois
                    )
for package in ${pacman_network_pkgs[*]}; do
  pacman -S --needed --noconfirm ${package}
done

systemctl enable rpcbind
systemctl start rpcbind

# set random hostname on each boot
bash ./setrandomhostname/install.sh


##########################################
# Development
##########################################
pacman_dev_pkgs=(
                git
                php
                python
                python-pip
                python2
                python2-pip
                )

for package in ${pacman_dev_pkgs[*]}; do
  pacman -S --needed --noconfirm ${package}
done
